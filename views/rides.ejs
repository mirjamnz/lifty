<%- include('partials/header1') %>
<%- include('partials/navbar1') %>

<div class="container py-5">
  <h2 class="mb-4">ğŸš— My Rides, <%= session.userName %>!</h2>

  <!-- FILTERS & VIEW SWITCH -->
  <div class="d-flex align-items-center mb-3">
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" id="toggleView" onchange="toggleViewMode()">
      <label class="form-check-label" for="toggleView">ğŸ—‹ï¸ Card View</label>
    </div>
    <div class="form-check form-check-inline ms-4">
      <input class="form-check-input" type="checkbox" id="seekingOnly" onchange="applyFilters()">
      <label class="form-check-label" for="seekingOnly">ğŸ‘“ Seeking Drivers Only</label>
    </div>
  </div>

  <!-- SEARCH BAR -->
  <div class="input-group mb-4">
    <span class="input-group-text">ğŸ”</span>
    <input type="text" id="rideSearch" class="form-control" placeholder="Search ride offers or requests...">
  </div>

  <!-- REQUEST + OFFER CTA -->
  <div class="row g-4 mb-4 align-items-stretch">
    <div class="col-md-6">
      <div class="p-3 border rounded shadow-sm bg-light h-100 d-flex flex-column justify-content-between">
        <h5>ğŸš˜ Offer a Ride</h5>
        <form action="/rides/offer-ride" method="POST" class="flex-grow-1 d-flex flex-column">
          <input type="text" name="school" class="form-control mb-2 autocomplete" data-type="school" placeholder="School Name" required>
          <input type="number" name="available_seats" class="form-control mb-2" placeholder="Seats Available" min="1" required>
          <input type="datetime-local" name="pickup_time" class="form-control mb-2" required>
          <textarea name="notes" class="form-control mb-2" placeholder="Optional notes..."></textarea>
          <button class="btn btn-primary w-100">ğŸš— Offer Ride</button>
        </form>
      </div>
    </div>
    <div class="col-md-6">
      <div class="p-3 border rounded shadow-sm bg-light h-100 d-flex flex-column justify-content-between">
        <h5>ğŸ“£ Request a Pickup</h5>
        <form action="/requests/request-ride" method="POST" class="flex-grow-1 d-flex flex-column">
          <input type="text" name="pickup_location" class="form-control mb-2 autocomplete" data-type="organization" placeholder="Search School, Club, or Event" required>
          <input type="text" name="dropoff_location" class="form-control mb-2 autocomplete" data-type="dropoff" placeholder="Search School, Club, or Event" required>
          <input type="datetime-local" name="pickup_time" class="form-control mb-2" required>
          <select name="child_id" class="form-select mb-2" required>
            <option disabled selected>Select Your Child</option>
            <% children.forEach(child => { %>
              <option value="<%= child.id %>"><%= child.name %> â€“ <%= child.school %></option>
            <% }) %>
          </select>
          <textarea name="note" class="form-control mb-2" placeholder="Additional details..."></textarea>
          <button class="btn btn-primary w-100">ğŸ“£ Request Pickup</button>
        </form>
      </div>
    </div>
  </div>

  <!-- RIDE OFFERS TABLE -->
  <% if (rideOffers.length > 0) { %>
    <h5 class="mt-4">ğŸš˜ Ride Offers</h5>
    <table class="table table-hover ride-table mb-4">
      <thead class="table-light">
        <tr>
          <th>Driver</th>
          <th>School</th>
          <th>Pickup</th>
          <th>Seats</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody>
        <% rideOffers.forEach(offer => { %>
          <tr data-seats="<%= offer.available_seats %>" data-type="offer">
            <td><strong><%= offer.driver_name %></strong></td>
            <td><%= offer.school %></td>
            <td><span class="text-primary" data-time="<%= offer.pickup_time %>"><%= new Date(offer.pickup_time).toLocaleString() %></span></td>
            <td><%= offer.available_seats %></td>
            <td><%= offer.notes || 'â€”' %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  <% } else { %>
    <p class="text-muted">No current ride offers.</p>
  <% } %>

  <!-- RIDE REQUESTS TABLE -->
  <% if (requests.length > 0) { %>
    <h5 class="mt-5">ğŸ“£ Ride Requests</h5>
    <table class="table table-striped ride-table">
      <thead class="table-light">
        <tr>
          <th>Child</th>
          <th>Pickup</th>
          <th>Dropoff</th>
          <th>Note</th>
          <th>Time</th>
          <th>Status</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <% requests.forEach(request => { %>
          <tr data-assigned="<%= request.assigned_user_id ? 'yes' : 'no' %>" data-type="request">
            <td><%= request.child_name %><br><small class="text-muted">by <%= request.user_name %></small></td>
            <td><%= request.pickup_location %></td>
            <td><%= request.dropoff_location || 'â€”' %></td>
            <td><%= request.note || 'â€”' %></td>
            <td><span class="text-info" data-time="<%= request.pickup_time %>"><%= new Date(request.pickup_time).toLocaleString() %></span></td>
            <td>
              <% if (!request.assigned_user_id) { %>
                <span class="badge bg-warning text-dark">Waiting</span>
              <% } else { %>
                <span class="badge bg-success">Assigned</span><br>
                <small class="text-muted"><%= request.assigned_driver_name %></small>
              <% } %>
            </td>
            <td>
              <% if (!request.assigned_user_id && request.user_id !== session.userId) { %>
                <form action="/requests/assign-request/<%= request.id %>" method="POST" class="d-inline" onsubmit="return confirmHelp('<%= request.child_name %>', '<%= request.user_name %>', '<%= request.pickup_location %>', '<%= request.dropoff_location %>', '<%= request.pickup_time %>');">
                  <button class="btn btn-sm btn-outline-success">Help</button>
                </form>
              <% } %>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  <% } else { %>
    <p class="text-muted">No ride requests found.</p>
  <% } %>
</div>

<!-- OPTIONAL CARD VIEW -->
<div id="rideCards" class="d-none flex-wrap gap-3"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-autocomplete@1.0.7/dist/bootstrap-autocomplete.min.js"></script>
<script>
  document.querySelectorAll('.autocomplete').forEach(input => {
    const type = input.dataset.type;
    new window.Autocomplete(input, {
      threshold: 1,
      onSearch: async ({ currentValue }) => {
        const res = await fetch(`/organizations/autocomplete?term=${encodeURIComponent(currentValue)}&type=${type}`);
        return await res.json();
      },
      onResults: ({ matches }) =>
        matches.map(m => `<li class="dropdown-item" data-value="${m.value}">${m.label}</li>`),
      onSubmit: ({ value }) => {
        input.value = value;
      }
    });
  });

  function confirmHelp(child, caregiver, pickup, dropoff, time) {
    const dt = new Date(time).toLocaleString();
    return confirm(`âœ… Thanks for helping out!\nWe have notified ${caregiver} that you will take ${child} from ${pickup} to ${dropoff} @ ${dt}.`);
  }

  function applyFilters() {
    const seekingOnly = document.getElementById('seekingOnly').checked;

    document.querySelectorAll('tbody tr').forEach(row => {
      const isAssigned = row.dataset.assigned === 'yes';
      const seats = parseInt(row.dataset.seats || '1');
      const isRequest = row.dataset.type === 'request';

      const shouldHide = seekingOnly && (isRequest ? isAssigned : seats === 0);
      row.style.display = shouldHide ? 'none' : '';
    });

    document.querySelectorAll('#rideCards .card').forEach(card => {
      const isAssigned = card.getAttribute('data-assigned') === 'yes';
      const seats = parseInt(card.getAttribute('data-seats') || '1');
      const type = card.getAttribute('data-type');

      const shouldHide = seekingOnly && (type === 'request' ? isAssigned : seats === 0);
      card.style.display = shouldHide ? 'none' : '';
    });
  }

  function populateRideCards() {
    const cardsContainer = document.getElementById('rideCards');
    cardsContainer.innerHTML = '';

    const rideOffers = <%- JSON.stringify(rideOffers) %>;
    const requests = <%- JSON.stringify(requests) %>;

    if (rideOffers.length > 0) {
      cardsContainer.innerHTML += `<h5 class="w-100">ğŸš˜ Ride Offers</h5>`;
      rideOffers.forEach(offer => {
        const card = document.createElement('div');
        card.className = 'card p-3 shadow-sm';
        card.style.width = '300px';
        card.setAttribute('data-seats', offer.available_seats);
        card.setAttribute('data-type', 'offer');
        card.innerHTML = `
          <h6 class="mb-1"><strong>${offer.driver_name}</strong></h6>
          <p class="mb-1"><strong>School:</strong> ${offer.school}</p>
          <p class="mb-1"><strong>Pickup:</strong> ${new Date(offer.pickup_time).toLocaleString()}</p>
          <p class="mb-1"><strong>Seats:</strong> ${offer.available_seats}</p>
          <p class="mb-0"><strong>Notes:</strong> ${offer.notes || 'â€”'}</p>
        `;
        cardsContainer.appendChild(card);
      });
    }

    if (requests.length > 0) {
      cardsContainer.innerHTML += `<h5 class="w-100 mt-4">ğŸ“£ Ride Requests</h5>`;
      requests.forEach(req => {
        const card = document.createElement('div');
        card.className = 'card p-3 shadow-sm';
        card.style.width = '300px';
        card.setAttribute('data-assigned', req.assigned_user_id ? 'yes' : 'no');
        card.setAttribute('data-type', 'request');
        card.innerHTML = `
          <h6 class="mb-1">${req.child_name}</h6>
          <p class="mb-1"><strong>By:</strong> ${req.user_name}</p>
          <p class="mb-1"><strong>Pickup:</strong> ${req.pickup_location}</p>
          <p class="mb-1"><strong>Dropoff:</strong> ${req.dropoff_location || 'â€”'}</p>
          <p class="mb-1"><strong>Time:</strong> ${new Date(req.pickup_time).toLocaleString()}</p>
          <p class="mb-1"><strong>Note:</strong> ${req.note || 'â€”'}</p>
          <p class="mb-1"><strong>Status:</strong> ${req.assigned_user_id ? `<span class='badge bg-success'>Assigned</span> <br><small>${req.assigned_driver_name}</small>` : `<span class='badge bg-warning text-dark'>Waiting</span>`}</p>
          ${!req.assigned_user_id && req.user_id !== <%= session.userId %> ? `
            <form action="/requests/assign-request/${req.id}" method="POST" onsubmit="return confirmHelp('${req.child_name}', '${req.user_name}', '${req.pickup_location}', '${req.dropoff_location}', '${req.pickup_time}');">
              <button class="btn btn-sm btn-outline-success w-100 mt-2">Help</button>
            </form>
          ` : ''}
        `;
        cardsContainer.appendChild(card);
      });
    }
    applyFilters();
  }

  function toggleViewMode() {
    const tables = document.querySelectorAll('.ride-table');
    const cards = document.getElementById('rideCards');
    const showCards = tables[0].style.display !== 'none';

    tables.forEach(t => t.style.display = showCards ? 'none' : 'table');
    cards.classList.toggle('d-none', !showCards);
    cards.classList.toggle('d-flex', showCards);

    if (showCards) populateRideCards();
  }

  window.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('[data-time]').forEach(el => {
      const raw = el.getAttribute('data-time');
      el.innerText = moment(raw).fromNow();
    });

    document.getElementById('rideSearch').addEventListener('input', e => {
      const q = e.target.value.toLowerCase();
      document.querySelectorAll('tbody tr').forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(q) ? '' : 'none';
      });
    });
  });
</script>

<%- include('partials/footer1') %>