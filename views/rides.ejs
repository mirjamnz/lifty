
<%- include('partials/header1') %>
<%- include('partials/navbar1') %>

<div class="container py-5">
  <h2 class="mb-4">ğŸš— My Rides, <%= session.userName %>!</h2>

  <!-- Filters -->
  <div class="d-flex align-items-center mb-3">
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" id="toggleView" onchange="toggleViewMode()">
      <label class="form-check-label" for="toggleView">ğŸ—‹ï¸ Card View</label>
    </div>
    <div class="form-check form-check-inline ms-4">
      <input class="form-check-input" type="checkbox" id="seekingOnly" onchange="applyFilters()">
      <label class="form-check-label" for="seekingOnly">ğŸ‘“ Seeking Drivers Only</label>
    </div>
  </div>

  <!-- Search -->
  <div class="input-group mb-4">
    <span class="input-group-text">ğŸ”</span>
    <input type="text" id="rideSearch" class="form-control" placeholder="Search ride offers or requests...">
  </div>

  <!-- Offer + Request Forms -->
  <div class="row g-4 mb-4">
    <div class="col-md-6">
      <div class="p-3 bg-light border rounded shadow-sm h-100 d-flex flex-column justify-content-between">
        <h5>ğŸš˜ Offer a Ride</h5>
        <form action="/rides/offer-ride" method="POST" class="flex-grow-1 d-flex flex-column">
          <input name="school" type="text" class="form-control mb-2 autocomplete" data-type="school" placeholder="School Name" required>
          <input type="number" name="available_seats" class="form-control mb-2" placeholder="Seats Available" min="1" required>
          <input type="datetime-local" name="pickup_time" class="form-control mb-2" required>
          <textarea name="notes" class="form-control mb-2" placeholder="Optional notes..."></textarea>
          <button class="btn btn-primary w-100">ğŸš— Offer Ride</button>
        </form>
      </div>
    </div>

    <div class="col-md-6">
      <div class="p-3 bg-light border rounded shadow-sm h-100 d-flex flex-column justify-content-between">
        <h5>ğŸ“£ Request a Pickup</h5>
        <form action="/requests/request-ride" method="POST" class="flex-grow-1 d-flex flex-column">
          <input name="pickup_location" type="text" class="form-control mb-2 autocomplete" data-type="organization" placeholder="Search School, Club, or Event" required>
          <input name="dropoff_location" type="text" class="form-control mb-2 autocomplete" data-type="organization" placeholder="Search School, Club, or Event" required>
          <input type="datetime-local" name="pickup_time" class="form-control mb-2" required>
          <select name="child_id" class="form-select mb-2" required>
            <option disabled selected>Select Your Child</option>
            <% children.forEach(child => { %>
              <option value="<%= child.id %>"><%= child.name %> â€“ <%= child.school %></option>
            <% }) %>
          </select>
          <textarea name="note" class="form-control mb-2" placeholder="Additional details..."></textarea>
          <button class="btn btn-primary w-100">ğŸ“£ Request Pickup</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Offers Table -->
  <% if (rideOffers.length > 0) { %>
    <h5 class="mt-4">ğŸš˜ Ride Offers</h5>
    <table class="table table-hover ride-table mb-4">
      <thead class="table-light">
        <tr><th>Driver</th><th>School</th><th>Pickup</th><th>Seats</th><th>Notes</th></tr>
      </thead>
      <tbody>
        <% rideOffers.forEach(offer => { %>
          <tr data-seats="<%= offer.available_seats %>" data-type="offer">
            <td><strong><%= offer.driver_name %></strong></td>
            <td><%= offer.school %></td>
            <td><span data-time="<%= offer.pickup_time %>"><%= new Date(offer.pickup_time).toLocaleString() %></span></td>
            <td><%= offer.available_seats %></td>
            <td><%= offer.notes || 'â€”' %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  <% } %>

  <!-- Requests Table -->
  <% if (requests.length > 0) { %>
    <h5 class="mt-5">ğŸ“£ Ride Requests</h5>
    <table class="table table-striped ride-table">
      <thead class="table-light">
        <tr><th>Child</th><th>Pickup</th><th>Dropoff</th><th>Note</th><th>Time</th><th>Status</th><th></th></tr>
      </thead>
      <tbody>
        <% requests.forEach(request => { %>
          <tr data-assigned="<%= request.assigned_user_id ? 'yes' : 'no' %>" data-type="request">
            <td><%= request.child_name %><br><small class="text-muted">by <%= request.user_name %></small></td>
            <td><%= request.pickup_location %></td>
            <td><%= request.dropoff_location || 'â€”' %></td>
            <td><%= request.note || 'â€”' %></td>
            <td><span data-time="<%= request.pickup_time %>"><%= new Date(request.pickup_time).toLocaleString() %></span></td>
            <td>
              <% if (!request.assigned_user_id) { %>
                <span class="badge bg-warning text-dark">Waiting</span>
              <% } else { %>
                <span class="badge bg-success">Assigned</span><br><small><%= request.assigned_driver_name %></small>
              <% } %>
            </td>
            <td>
              <% if (!request.assigned_user_id && request.user_id !== session.userId) { %>
                <form action="/requests/assign-request/<%= request.id %>" method="POST" onsubmit="return confirmHelp('<%= request.child_name %>', '<%= request.user_name %>', '<%= request.pickup_location %>', '<%= request.dropoff_location %>', '<%= request.pickup_time %>');">
                  <button class="btn btn-sm btn-outline-success">Help</button>
                </form>
              <% } %>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  <% } %>
</div>

<div id="rideCards" class="d-none flex-wrap gap-3 px-4"></div>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@10.2.7/dist/css/autoComplete.min.css">
<script src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@10.2.7/dist/autoComplete.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Human-readable times
  document.querySelectorAll('[data-time]').forEach(el => {
    el.innerText = moment(el.dataset.time).fromNow();
  });

  // Table search filter
  document.getElementById('rideSearch').addEventListener('input', e => {
    const q = e.target.value.toLowerCase();
    document.querySelectorAll('tbody tr').forEach(row => {
      row.style.display = row.innerText.toLowerCase().includes(q) ? '' : 'none';
    });
  });

  // âœ… Autocomplete logic
  document.querySelectorAll('.autocomplete').forEach(input => {
    const type = input.dataset.type || 'organization';

    new autoComplete({
      selector: () => input,
      threshold: 1,
      debounce: 200,
      searchEngine: "loose",
      data: {
        src: async (query) => {
          try {
            const res = await fetch(`/organizations/autocomplete?term=${encodeURIComponent(query)}&type=${encodeURIComponent(type)}`);
            return await res.json(); // [{ label: 'Westlake Girls', value: 'Westlake Girls' }, ...]
          } catch (err) {
            console.error("Autocomplete fetch error", err);
            return [];
          }
        },
        keys: ["label"] // allow searching inside the label field
      },
      resultsList: {
        noResults: true,
        maxResults: 10
      },
      resultItem: {
  highlight: true,
  element: (el, data) => {
    el.innerHTML = `<div class="dropdown-item">${data.value.label}</div>`; // âœ… show the label in dropdown
  }
},
onSelection: (feedback) => {
  input.value = feedback.selection.value.label; // âœ… fill in the input with selected label
}

    });
  });
});
</script>

<%- include('partials/footer1') %>