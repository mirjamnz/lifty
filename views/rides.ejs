<%- include('partials/header1') %>
<%- include('partials/navbar1') %>

<div class="container py-5">
  <h2 class="mb-4">ğŸš— My Rides, <%= session.userName %>!</h2>



 <!-- Filter, View + Hide Expired option -->
  <form method="GET" action="/rides" class="d-flex gap-2 align-items-center mb-3">
  <input type="hidden" name="filter" value="<%= filter %>">
  <div class="btn-group">
      <a href="/rides?filter=all" class="btn btn-sm <%= filter === 'all' ? 'btn-primary' : 'btn-outline-primary' %>">All</a>
      <a href="/rides?filter=my" class="btn btn-sm <%= filter === 'my' ? 'btn-primary' : 'btn-outline-primary' %>">My Requests</a>
      <a href="/rides?filter=others" class="btn btn-sm <%= filter === 'others' ? 'btn-primary' : 'btn-outline-primary' %>">Others'</a>
  </div>
  <div class="form-check form-switch ms-3">
    <input class="form-check-input" type="checkbox" name="expired" value="false" id="hideExpired" onchange="this.form.submit()" <%= expired === 'false' ? 'checked' : '' %>>
    <label class="form-check-label" for="hideExpired">Hide expired</label>
  </div>
  <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" id="toggleView" onchange="toggleViewMode()">
      <label class="form-check-label" for="toggleView">ğŸ“‚ Card View</label>
    </div>
</form>


  <!-- QUICK SEARCH -->
  <div class="input-group mb-4">
    <span class="input-group-text">ğŸ”</span>
    <input type="text" id="rideSearch" class="form-control" placeholder="Search rides or requests...">
  </div>

  <!-- TABLE VIEW -->
  <div id="tableView">
    <!-- Ride Offers -->
    <% if (rideOffers.length > 0) { %>
      <h5>ğŸš˜ Ride Offers</h5>
      <table class="table table-hover mb-4 ride-table">
        <thead class="table-light">
          <tr>
            <th>Driver</th>
            <th>School</th>
            <th>Pickup</th>
            <th>Seats</th>
            <th>Notes</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <% rideOffers.forEach(offer => { %>
            <tr>
              <td><strong><%= offer.driver_name %></strong></td>
              <td><%= offer.school %></td>
              <td><span data-time="<%= offer.pickup_time %>"><%= new Date(offer.pickup_time).toLocaleString() %></span></td>
              <td><span class="badge bg-success"><%= offer.available_seats %></span></td>
              <td><%= offer.notes || 'â€”' %></td>
              <td>
                <% if (offer.user_id === session.userId) { %>
                  <form action="/rides/cancel-offer/<%= offer.id %>" method="POST" class="d-inline">
                    <button class="btn btn-sm btn-outline-danger">âŒ</button>
                  </form>
                <% } %>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    <% } %>

    <!-- Ride Requests -->
    <h5>ğŸ“£ Ride Requests</h5>
    <table class="table table-striped ride-table">
      <thead class="table-light">
        <tr>
          <th>Child</th>
          <th>From</th>
          <th>To</th>
          <th>Note</th>
          <th>Time</th>
          <th>Status</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <% requests.forEach(request => { %>
          <tr>
            <td><%= request.child_name %><br><small class="text-muted">by <%= request.user_name %></small></td>
            <td><%= request.pickup_location %></td>
            <td><%= request.dropoff_location || 'â€”' %></td>
            <td><%= request.note || 'â€”' %></td>
            <td><span data-time="<%= request.created_at %>"><%= new Date(request.created_at).toLocaleString() %></span></td>
            <td>
              <% if (!request.assigned_user_id) { %>
                <span class="badge bg-warning text-dark">Waiting</span>
              <% } else { %>
                <span class="badge bg-success">Assigned to <%= request.assigned_driver_name %></span>
              <% } %>
            </td>
            <td>
              <% if (request.user_id === session.userId || request.assigned_user_id === session.userId) { %>
                <form action="/requests/cancel-request/<%= request.id %>" method="POST" class="d-inline">
                  <button class="btn btn-sm btn-outline-danger">âŒ</button>
                </form>
              <% } %>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

  <!-- CARD VIEW -->
  <div class="row" id="cardView" style="display:none;">
    <h5 class="mb-3">ğŸš˜ Ride Offers</h5>
    <% rideOffers.forEach(offer => { %>
      <div class="col-md-6 mb-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title"><%= offer.school %></h5>
            <p class="card-text">ğŸ•’ <%= new Date(offer.pickup_time).toLocaleString() %></p>
            <p class="card-text">ğŸš— <strong><%= offer.driver_name %></strong> &mdash; <%= offer.available_seats %> seats</p>
            <p class="card-text text-muted"><%= offer.notes || 'No notes' %></p>
          </div>
        </div>
      </div>
    <% }) %>
  </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<script>
function toggleViewMode() {
  const table = document.getElementById('tableView');
  const cards = document.getElementById('cardView');
  if (cards.style.display === 'none') {
    cards.style.display = 'flex';
    table.style.display = 'none';
  } else {
    cards.style.display = 'none';
    table.style.display = 'block';
  }
}

document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('[data-time]').forEach(el => {
    const raw = el.getAttribute('data-time');
    el.innerText = moment(raw).fromNow();
  });

  document.getElementById('rideSearch').addEventListener('input', e => {
    const q = e.target.value.toLowerCase();
    document.querySelectorAll('tbody tr').forEach(row => {
      row.style.display = row.innerText.toLowerCase().includes(q) ? '' : 'none';
    });
  });
});
</script>

<%- include('partials/footer1') %>
