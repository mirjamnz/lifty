<%- include('partials/header1') %>
<%- include('partials/navbar1') %>

<div class="container py-5">
  <% if (session.success) { %>
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <%= session.success %>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <% session.success = null; %>
  <% } %>

  <h2 class="mb-4 fw-semibold">ğŸ‘‹ Welcome, <%= session.userName %>!</h2>

  <!-- Home Address -->
  <div class="card mb-4 shadow-sm rounded-4">
    <div class="card-body">
      <h5 class="card-title fw-semibold">ğŸ  Your Home Address</h5>
      <form action="/update-address" method="POST" class="row g-2" onsubmit="return validateCoords();">
        <div class="col-md-8">
          <input type="text" name="home_address" id="homeAddress" class="form-control rounded-pill" value="<%= user.home_address || '' %>" required>
        </div>
        <input type="hidden" name="home_lat" id="homeLat">
        <input type="hidden" name="home_lng" id="homeLng">
        <div class="col-md-4">
          <button type="submit" class="btn btn-success w-100 rounded-pill">ğŸ“ Save</button>
        </div>
      </form>
      <div id="map" class="mt-3 rounded shadow-sm" style="height: 300px;"></div>
    </div>
  </div>

  <!-- Children + Organizations in 2 columns -->
 <div class="row">
  <!-- ğŸ‘¶ Your Children -->
  <div class="col-md-6 mb-4">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h5 class="card-title mb-3">ğŸ‘¶ Your Children</h5>

        <% if (children.length > 0) { %>
          <ul class="list-group mb-4">
            <% children.forEach(child => { %>
              <li class="list-group-item">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <strong><%= child.name %></strong> â€“ <%= child.school %>
                    <% if (child.club) { %> | Club: <%= child.club %> <% } %>
                  </div>
                  <div>
                    <button class="btn btn-sm btn-outline-secondary me-2" data-bs-toggle="collapse" data-bs-target="#editForm<%= child.id %>">âœï¸</button>
                    <a href="/delete-child/<%= child.id %>" class="btn btn-sm btn-outline-danger">ğŸ—‘</a>
                  </div>
                </div>
                <div class="collapse mt-2" id="editForm<%= child.id %>">
                  <form action="/edit-child/<%= child.id %>" method="POST" class="row g-2">
                    <div class="col-md-4">
                      <input type="text" name="name" value="<%= child.name %>" class="form-control" required>
                    </div>
                    <div class="col-md-4">
                      <input type="text" name="school" value="<%= child.school %>" class="form-control" required>
                    </div>
                    <div class="col-md-3">
                      <input type="text" name="club" value="<%= child.club %>" class="form-control" placeholder="Club (optional)">
                    </div>
                    <div class="col-md-1">
                      <button type="submit" class="btn btn-primary w-100">ğŸ’¾</button>
                    </div>
                  </form>
                </div>
              </li>
            <% }) %>
          </ul>
        <% } else { %>
          <p class="text-muted">No children registered yet.</p>
        <% } %>

        <form action="/add-child" method="POST" class="row g-2 mt-2">
  <div class="col-md-3">
    <input type="text" name="name" class="form-control" placeholder="Child's Name" required>
  </div>
  <div class="col-md-3">
    <input type="text" name="school" class="form-control" placeholder="School" required>
  </div>
  <div class="col-md-2">
    <input type="text" name="club" class="form-control" placeholder="Club (optional)">
  </div>
  <div class="col-md-2">
    <input type="text" name="child_username" class="form-control" placeholder="Username">
  </div>
  <div class="col-md-1">
    <input type="password" name="child_password" class="form-control" placeholder="Password">
  </div>
  <div class="col-md-1">
    <button type="submit" class="btn btn-success w-100">Add</button>
  </div>
</form>



  <!-- ğŸ« Clubs & Schools -->
  <div class="col-md-6 mb-4">
    <div class="card shadow-sm h-100">
      <div class="card-body d-flex flex-column">
        <h5 class="card-title">ğŸ« Clubs & Schools</h5>

        <form class="input-group mb-3" method="GET" action="/organizations/search">
          <input type="text" name="q" class="form-control" placeholder="Search...">
          <button class="btn btn-outline-secondary" type="submit">ğŸ”</button>
        </form>

        <div style="max-height: 280px; overflow-y: auto;" class="mb-3 border rounded p-2">
          <% if (organizations && organizations.length > 0) { %>
            <ul class="list-group">
              <% organizations.forEach(org => { %>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <span><%= org.name %> <small class="text-muted">(<%= org.type %>)</small></span>
                </li>
              <% }) %>
            </ul>
          <% } else { %>
            <p class="text-muted">No organizations available yet.</p>
          <% } %>
        </div>

        <a href="/organizations/add" class="btn btn-outline-primary mt-auto w-100">â• Add New School or Club</a>
      </div>
    </div>
  </div>
</div>


<script>
  function validateCoords() {
    const lat = document.getElementById('homeLat').value;
    const lng = document.getElementById('homeLng').value;
    if (!lat || !lng) {
      alert("Please select an address from the suggestions.");
      return false;
    }
    return true;
  }

  function initMap() {
    const userLoc = {
      lat: <%= user.home_lat || -36.8485 %>,
      lng: <%= user.home_lng || 174.7633 %>
    };
    const map = new google.maps.Map(document.getElementById('map'), {
      center: userLoc,
      zoom: 12
    });
    new google.maps.Marker({ position: userLoc, map, title: "Your Home" });

    <% neighbors.forEach(n => { %>
      new google.maps.Marker({
        position: { lat: <%= n.home_lat %>, lng: <%= n.home_lng %> },
        map,
        title: "<%= n.name %>"
      });
    <% }); %>

    const autocomplete = new google.maps.places.Autocomplete(document.getElementById('homeAddress'));
    autocomplete.addListener('place_changed', function () {
      const place = autocomplete.getPlace();
      if (place.geometry) {
        document.getElementById('homeLat').value = place.geometry.location.lat();
        document.getElementById('homeLng').value = place.geometry.location.lng();
      }
    });
  }

  // Live search filter for organization list
  document.addEventListener('DOMContentLoaded', () => {
    const input = document.getElementById('orgSearch');
    input?.addEventListener('keyup', () => {
      const val = input.value.toLowerCase();
      document.querySelectorAll('#orgList li').forEach(li => {
        li.style.display = li.innerText.toLowerCase().includes(val) ? '' : 'none';
      });
    });
  });
</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=<%= GMAPS_API_KEY %>&libraries=places&callback=initMap"></script>
<%- include('partials/footer1') %>
